<!DOCTYPE html>
<html lang="en">

<head>
   <!-- basic -->
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <!-- mobile metas -->
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta name="viewport" content="initial-scale=1, maximum-scale=1">
   <!-- site metas -->
   <title>Movie Room Player</title>
   <meta name="keywords" content="">
   <meta name="description" content="">
   <meta name="author" content="">
   <!-- bootstrap css -->
   <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
   <!-- style css -->
   <link rel="stylesheet" type="text/css" href="css/style.css">
   <!-- Responsive-->
   <link rel="stylesheet" href="css/responsive.css">
   <script src="https://code.jquery.com/jquery-3.6.1.js" integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI="
      crossorigin="anonymous"></script>
   <!-- fevicon -->
   <link rel="icon" href="images/fevicon.png" type="image/gif" />
   <!-- Scrollbar Custom CSS -->
   <link rel="stylesheet" href="css/jquery.mCustomScrollbar.min.css">
   <!-- Tweaks for older IEs-->
   <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
   <!-- owl stylesheets -->
   <link rel="stylesheet" href="css/owl.carousel.min.css">
   <link rel="stylesheet" href="css/owl.theme.default.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css"
      media="screen">
   <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
</head>

<body>
   <!-- header section start -->
   <div class="header_section">
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
         <a class="logo" href="index.html"><img src="images/logo.png"></a>
         <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
         </button>
         <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
               <li class="nav-item active">
                  <a class="nav-link" href="index.html">Inicio</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="create.html">Crear Sala</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="join.html">Unirse a Sala</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="celebs.html">Contacto</a>
               </li>
            </ul>

         </div>
      </nav>
      <!-- header section end -->
      <!-- arrival section start -->
      <div class="arrival_section layout_padding">
         <div class="container" style=" text-align: center; align-items: center;">
            <h1>Conectarse a una sala de peliculas:</h1>

            <label for="fname">Id de sala:</label><br>
            <input type="text" id="idSala" name="idRoom"><br><br>
            <h4> Codigo para videollamada</h4>
            <p id="h2Code"></p>
            <button onclick="" style="width: 170px;
            font-size: 18px;
            color: #ffffff;
            text-align: center;
            background-color: #df9911;
            padding: 7px 0px;
            border-radius: 30px;
            margin-top: 60px;">Cargar sala</button>
            <br><br>
            <h1 id="titulo"></h1>
            <video controls style="object-fit: fill; height: 60vh; width: 60vw;"></video><br>

         </div>
         <div style="  align-items: center; text-align: center;"><br><br><br>
            <h1> Prueba de llamadas (solo voz)</h1>
            <img style="height: 50%; width:50%;" src="images/gato.jpg"><br>
            <label for="fname">Ingresar id a llamar:</label><br>
            <input type="text" id="idLlamar" name="idRoom"><br><br>
            <a id="llamar" style="width: 170px;
               font-size: 18px;
               color: #ffffff;
               text-align: center;
               background-color: #df9911;
               padding: 7px 0px;
               border-radius: 30px;
               margin-top: 60px;">Iniciar llamada</a>
            <video id="my-video"></video>
         </div>
      </div>

      <!-- arrival section end -->
      <!-- footer  section start -->
      <div class=" footer_section layout_padding">
         <div class="container">

            <div class="social_icon">
               <ul>
                  <li><a href="#"><img src="images/fb-icon.png"></a></li>
                  <li><a href="#"><img src="images/twitter-icon.png"></a></li>
                  <li><a href="#"><img src="images/linkedin-icon.png"></a></li>
                  <li><a href="#"><img src="images/instagram-icon.png"></a></li>
               </ul>
            </div>
         </div>
      </div>
      <!-- footer  section end -->
      <!-- copyright section start 
<div class="copyright_section">
<div class="container">
   <div class="copyright_text">By ispa16 <a href="https://html.design">Free html
         Templates</a></div>
</div>
</div>  -->
      <!-- copyright section end -->
      <!-- Javascript files-->
      <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
      <script type="module">
         // Import the functions you need from the SDKs you need
         import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-app.js";
         import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-analytics.js";
         //import { auth } from 'https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js'
         import { collection, orderBy, getFirestore, doc, getDocs, onSnapshot, query, limit, where, updateDoc } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-firestore.js";
         // TODO: Add SDKs for Firebase products that you want to use
         // https://firebase.google.com/docs/web/setup#available-libraries

         // Your web app's Firebase configuration
         // For Firebase JS SDK v7.20.0 and later, measurementId is optional
         const firebaseConfig = {
            apiKey: "AIzaSyCNAGs57fyZC47gphecD-XmsKbcZMfK7Vg",
            authDomain: "movie-2768b.firebaseapp.com",
            projectId: "movie-2768b",
            storageBucket: "movie-2768b.appspot.com",
            messagingSenderId: "1057326711861",
            appId: "1:1057326711861:web:f63052b3f095848d6c1d7c",
            measurementId: "G-XRCB0HPX6P"
         };

         // Initialize Firebase
         const app = initializeApp(firebaseConfig);
         const db = getFirestore(app);
         const analytics = getAnalytics(app);
         $("button").click(function () {
            var idPelic = $("#idSala").val();
            console.log(idPelic.toString());
            const q = query(collection(db, "rooms"), where("id", "==", idPelic.toString()));//, where("hour", ">", time));
            if (q.empty) {
               window.alert("no se ha encontrado una sala con ese id");
            } else {
               window.alert("sala cargada con exito");
            }
            var docId;
            async function actualizar(id, boleano) {
               const docRef = doc(db, 'rooms', id);
               await updateDoc(docRef, {
                  onPlay: boleano
               });
            }
            async function actualizarFullScreen(id, boleano) {
               const docRef = doc(db, 'rooms', id);
               await updateDoc(docRef, {
                  fullScreen: boleano
               });
            }
            //funcion de carga de link
            function cargarVideo(url) {
               var newfile = url;
               var video = $("video")[0];
               video.pause();
               $("video").attr('src', newfile);
               video.load();

            }
            function openFullscreen(myVideo) {
               console.log("hitting")
               var elem = myVideo
               console.log(elem)
               if (elem.requestFullscreen) {
                  elem.requestFullscreen();
               } else if (elem.mozRequestFullScreen) { /* Firefox */
                  elem.mozRequestFullScreen();
               } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                  elem.webkitRequestFullscreen();
               } else if (elem.msRequestFullscreen) { /* IE/Edge */
                  elem.msRequestFullscreen();
               }
            }
            const unsubscribe = onSnapshot(q, (snapshot) => {
               snapshot.docChanges().forEach((change) => {
                  docId = change.doc.id;
                  if (change.type === "added") {
                     //console.log("New city: i", change.doc.id);
                     //addData(myChart, change.doc.data().hour, change.doc.data().x);
                     cargarVideo(change.doc.data().link);
                     $("#titulo").text(change.doc.data().nombre);
                     //"http://www.w3schools.com/html/mov_bbb.mp4"
                  }
                  if (change.type === "modified") {
                     console.log("Modified city: ", change.doc.data());
                     var play = change.doc.data().onPlay;
                     var fullSc = change.doc.data().fullScreen;
                     if (play == "true") {
                        $('video').get(0).play()
                     } else {
                        $('video').get(0).pause()
                     }
                     /* solo funciona si es que se hace un evento manual por el usuario
                     if (fullSc == "true") {
                        var myVideo = $("video")[0];
                        openFullscreen(myVideo);
                     } else {
                        var myVideo = $("video")[0];
                        openFullscreen(myVideo);
                     }
                     */
                  }
                  if (change.type === "removed") {
                     console.log("Removed city: ", change.doc.data());
                  }
               });
            });
            $('video').bind('play', function (e) {
               console.log("play");
               actualizar(docId, "true");
            });
            $('video').bind('pause', function (e) {
               console.log("pause");
               actualizar(docId, "false");
            });
            $('video').on('fullscreenchange webkitfullscreenchange mozfullscreenchange', function () {
               var muted = document.fullscreenElement;
               if (muted != null) {
                  console.log("fullScrenn");
                  //actualizarFullScreen(docId, "true")
               } else {
                  //actualizarFullScreen(docId, "false")
                  console.log("noFullScrenn");
               }
               //console.log(muted);
            });
            //
         });
      </script>
      <script>
         var peer = new Peer();
         peer.on('open', function (id) {
            console.log('My peer ID is: ' + id);
            $("#h2Code").text(id);
         });

         peer.on('call', function (call) {
            // Answer the call, providing our mediaStream
            navigator.mediaDevices.getUserMedia({ video: false, audio: true })
               .then(function (stream) {
                  call.answer(stream);
               });
         });
         $("#llamar").click(function () {
            var idPelic = $("#idLlamar").val();
            navigator.mediaDevices.getUserMedia({ video: false, audio: true })
               .then(function (stream) {
                  call = peer.call(idPelic, stream);
                  call.on('stream', function (stream) { // B
                     //$('#their-video').prop('src', URL.createObjectURL(stream))
                     $('#my-video').prop('src', URL.createObjectURL(stream));
                     window.localStream = stream;
                  })
               })
               .catch(function (err) {
                  console.log("error: " + err);
               });
         });
      </script>
      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.bundle.min.js"></script>
      <!-- sidebar -->
      <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
      <script src="js/custom.js"></script>
      <!-- javascript -->
      <script src="js/owl.carousel.js"></script>
      <script src="https:cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>
      <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
      <script>
         $('#datepicker').datepicker({
            uiLibrary: 'bootstrap4'
         });
      </script>
</body>

</html>